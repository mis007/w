<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI è¯­éŸ³åŠ©æ‰‹</title>
    <link rel="stylesheet" href="style.css">
    <!-- å¼•å…¥ Dexie.js -->
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <!-- ç§˜å¯†å…¥å£ï¼šç‚¹å‡»æ ‡é¢˜ 3 æ¬¡è§¦å‘ -->
            <h1 id="secret-trigger" style="user-select: none; cursor: default;">AI è¯­éŸ³åŠ©æ‰‹</h1>
            <p>ç‚¹å‡»éº¦å…‹é£å¼€å§‹å¯¹è¯</p>
            <button id="clear-btn" style="position: absolute; right: 15px; top: 15px; border: none; background: none; color: #999; cursor: pointer;">ğŸ—‘ï¸</button>
        </header>

        <div id="chat-box" class="chat-box">
            <div class="message system">
                <div class="bubble">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI åŠ©æ‰‹ï¼Œè¯·æŒ‰ä½ä¸‹æ–¹æŒ‰é’®è¯´è¯ã€‚</div>
            </div>
        </div>

        <div class="controls">
            <button id="mic-btn" class="mic-btn">
                <span class="icon">ğŸ¤</span>
                <span class="text">æŒ‰ä½ è¯´è¯</span>
            </button>
        </div>
    </div>

    <!-- ç§˜å¯†é…ç½®é¢æ¿ (é»˜è®¤éšè—) -->
    <div id="secret-panel" class="secret-panel hidden">
        <div class="panel-content">
            <h3>ğŸ”§ å¼€å‘è€…é…ç½®</h3>
            <div class="form-group">
                <label>Mode (æ¶æ„æ¨¡å¼):</label>
                <select id="config-mode">
                    <option value="low">ä½é…ç‰ˆ (Low-Spec / Multimodal)</option>
                    <option value="mid">ä¸­é…ç‰ˆ (Mid-Spec / Classic)</option>
                    <option value="high">é«˜é…ç‰ˆ (High-Spec / Pro)</option>
                </select>
            </div>
            <div class="form-group">
                <label>API Endpoint:</label>
                <input type="text" id="config-api" placeholder="https://api.example.com/v1/chat">
            </div>
            <div class="form-group">
                <label>API Key:</label>
                <input type="password" id="config-key" placeholder="sk-...">
            </div>
            <div class="form-group">
                <label>Model Name:</label>
                <input type="text" id="config-model" placeholder="gpt-4o-mini">
            </div>
            <div class="form-group">
                <label>System Prompt:</label>
                <textarea id="config-prompt" rows="3" placeholder="ä½ æ˜¯ä¸€ä¸ª..."></textarea>
            </div>
            <div class="preset-info">
                <h4>é¢„è®¾å‚æ•°:</h4>
                <p><strong>é˜¿é‡Œäº‘(DashScope):</strong></p>
                <p>API Key: sk-0ecae1777d2240ea862cdc1d73d5d645b3</p>
                <p>Endpoint: https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation</p>
                <br>
                <p><strong>æ™ºè°±AI:</strong></p>
                <p>API Key: a049afdafb1b41a0862cdc1d73d5d6eb.YuGYXVGRQEUILpog</p>
                <p>Endpoint: https://open.bigmodel.cn/api/paas/v4/</p>
            </div>
            <div class="panel-actions">
                <button id="save-config-btn" class="primary">ä¿å­˜é…ç½®</button>
                <button id="close-panel-btn">å…³é—­</button>
            </div>
        </div>
    </div>

    <script src="VoiceChat.js"></script>
    <script src="db.js"></script>
    <script src="version-manager.js"></script>
    <!-- å¼•å…¥åˆ†åŒ…ç­–ç•¥ -->
    <script src="low/strategy.js"></script>
    <script src="mid/strategy.js"></script>
    <script src="high/strategy.js"></script>
    <script>
        // UI å…ƒç´ 
        const micBtn = document.getElementById('mic-btn');
        const chatBox = document.getElementById('chat-box');
        const btnText = micBtn.querySelector('.text');
        const clearBtn = document.getElementById('clear-btn');

        // --- ç§˜å¯†å…¥å£é€»è¾‘ ---
        const secretTrigger = document.getElementById('secret-trigger');
        const secretPanel = document.getElementById('secret-panel');
        const closePanelBtn = document.getElementById('close-panel-btn');
        const saveConfigBtn = document.getElementById('save-config-btn');
        
        let clickCount = 0;
        let clickTimer = null;

        // 1. è§¦å‘é€»è¾‘ï¼šè¿ç»­ç‚¹å‡» 3 æ¬¡æ ‡é¢˜
        secretTrigger.addEventListener('click', () => {
            clickCount++;
            
            // 500ms å†…æ²¡æœ‰ç»§ç»­ç‚¹å‡»åˆ™é‡ç½®
            if (clickTimer) clearTimeout(clickTimer);
            clickTimer = setTimeout(() => { clickCount = 0; }, 500);

            if (clickCount === 3) {
                const pwd = prompt("è¯·è¾“å…¥å¼€å‘è€…å¯†ç ï¼š");
                if (pwd === "ircoco000") {
                    openSecretPanel();
                } else {
                    alert("å¯†ç é”™è¯¯");
                }
                clickCount = 0;
            }
        });

        // 2. æ‰“å¼€é¢æ¿å¹¶å›æ˜¾é…ç½®
        async function openSecretPanel() {
            // 1. å…ˆè·å–å…¨å±€é…ç½® (ä¸»è¦æ˜¯å½“å‰é€‰ä¸­çš„ mode)
            const currentVersion = await globalDB.getCurrentVersion();
            const mode = currentVersion || 'low';
            
            document.getElementById('config-mode').value = mode;
            
            // 2. åŠ è½½è¯¥æ¨¡å¼ä¸‹çš„å…·ä½“é…ç½®
            await loadConfigForMode(mode);
            
            secretPanel.classList.remove('hidden');
        }

        // è¾…åŠ©ï¼šåŠ è½½æŒ‡å®šæ¨¡å¼çš„é…ç½®åˆ°è¡¨å•
        async function loadConfigForMode(mode) {
            // ä½¿ç”¨ç‰ˆæœ¬ç®¡ç†å™¨è·å–é…ç½®
            const config = await versionManager.getVersionConfig(mode) || {};
            document.getElementById('config-api').value = config.apiEndpoint || '';
            document.getElementById('config-key').value = config.apiKey || '';
            document.getElementById('config-model').value = config.model || '';
            document.getElementById('config-prompt').value = config.systemPrompt || '';
        }

        // ç›‘å¬æ¨¡å¼åˆ‡æ¢ï¼šè‡ªåŠ¨ä¿å­˜æ—§æ¨¡å¼æ•°æ®ï¼ŒåŠ è½½æ–°æ¨¡å¼æ•°æ®
        const modeSelect = document.getElementById('config-mode');
        let previousMode = 'low'; // è®°å½•ä¸Šä¸€æ¬¡çš„æ¨¡å¼

        // é¢æ¿æ‰“å¼€æ—¶åˆå§‹åŒ– previousMode
        secretTrigger.addEventListener('click', async () => {
             // ... (existing logic) ...
             if (clickCount === 3) {
                 // ...
                 if (pwd === "ircoco000") {
                     const currentVersion = await globalDB.getCurrentVersion();
                     previousMode = currentVersion || 'low';
                     openSecretPanel();
                 }
                 // ...
             }
        });

        modeSelect.addEventListener('focus', () => {
            previousMode = modeSelect.value;
        });

        modeSelect.addEventListener('change', async () => {
            const newMode = modeSelect.value;
            
            // 1. ä¿å­˜æ—§æ¨¡å¼çš„è¡¨å•æ•°æ®
            const oldConfig = {
                apiEndpoint: document.getElementById('config-api').value,
                apiKey: document.getElementById('config-key').value,
                model: document.getElementById('config-model').value,
                systemPrompt: document.getElementById('config-prompt').value
            };
            await versionManager.saveVersionConfig(previousMode, oldConfig);
            console.log(`å·²è‡ªåŠ¨ä¿å­˜ [${previousMode}] é…ç½®`);

            // 2. åŠ è½½æ–°æ¨¡å¼çš„æ•°æ®
            await loadConfigForMode(newMode);
            
            // æ›´æ–°æŒ‡é’ˆ
            previousMode = newMode;
        });

        // 3. å…³é—­é¢æ¿
        closePanelBtn.addEventListener('click', () => {
            secretPanel.classList.add('hidden');
        });

        // 4. ä¿å­˜é…ç½® (æœ€ç»ˆä¿å­˜)
        saveConfigBtn.addEventListener('click', async () => {
            const currentMode = document.getElementById('config-mode').value;
            
            // 1. ä¿å­˜å½“å‰æ¨¡å¼çš„å…·ä½“é…ç½®åˆ°ç‰ˆæœ¬ä¸“ç”¨æ•°æ®åº“
            const modeConfig = {
                apiEndpoint: document.getElementById('config-api').value,
                apiKey: document.getElementById('config-key').value,
                model: document.getElementById('config-model').value,
                systemPrompt: document.getElementById('config-prompt').value
            };
            await versionManager.saveVersionConfig(currentMode, modeConfig);

            // 2. ä¿å­˜å…¨å±€é…ç½® (è®°å½•å½“å‰é€‰ä¸­çš„æ¨¡å¼)
            await globalDB.setCurrentVersion(currentMode);
            
            alert(`[${currentMode}] æ¨¡å¼é…ç½®å·²ä¿å­˜ï¼`);
            secretPanel.classList.add('hidden');
            
            // æ¸²æŸ“é¡µé¢ä»¥åº”ç”¨æ–°é…ç½®
            location.reload();
        });
        // --- ç§˜å¯†å…¥å£é€»è¾‘ç»“æŸ ---

        // é¡µé¢åŠ è½½æ—¶ï¼šåˆå§‹åŒ–ç³»ç»Ÿ
        (async function init() {
            try {
                // 1. åˆå§‹åŒ–å…¨å±€æ•°æ®åº“
                await globalDB.init();
                
                // 2. åˆå§‹åŒ–ç‰ˆæœ¬ç®¡ç†å™¨ï¼ˆä¼šåŠ è½½å„ç‰ˆæœ¬ç­–ç•¥å’Œæ•°æ®åº“ï¼‰
                await versionManager.initialize();
                
                // 3. è·å–å½“å‰ç‰ˆæœ¬çš„æ•°æ®åº“å®ä¾‹
                const currentVersion = await globalDB.getCurrentVersion();
                const currentDB = versionManager.getCurrentDB() || versionManager.getDB('low');
                
                // 4. åŠ è½½å†å²è®°å½•
                const history = await currentDB.getHistory();
                history.forEach(msg => {
                    renderMessage(msg);
                });
            } catch (e) {
                console.error('Init failed:', e);
            }
        })();

        // æ¸…ç©ºå†å²
        clearBtn.addEventListener('click', async () => {
            if(confirm('ç¡®å®šè¦æ¸…ç©ºèŠå¤©è®°å½•å—ï¼Ÿ')) {
                // æ¸…ç©ºå½“å‰ç‰ˆæœ¬çš„æ•°æ®åº“å†å²è®°å½•
                const currentDB = versionManager.getCurrentDB();
                await currentDB.clearAll();
                chatBox.innerHTML = '<div class="message system"><div class="bubble">è®°å½•å·²æ¸…ç©º</div></div>';
            }
        });

        // æ¸²æŸ“æ¶ˆæ¯åˆ°ç•Œé¢ (æ”¯æŒåˆ é™¤)
        function renderMessage(msg) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${msg.role}`;
            msgDiv.dataset.id = msg.id; // ç»‘å®š ID ç”¨äºåˆ é™¤

            // æ¶ˆæ¯å†…å®¹
            let contentHtml = `<div class="bubble">${msg.content}</div>`;
            
            // åˆ é™¤æŒ‰é’® (ä»…åœ¨ hover æˆ–é•¿æŒ‰æ—¶æ˜¾ç¤ºï¼Œè¿™é‡Œç®€åŒ–ä¸ºä¸€ç›´å­˜åœ¨çš„å°å›¾æ ‡)
            const deleteBtn = `<span class="delete-msg" onclick="deleteMessage(${msg.id}, this)">Ã—</span>`;
            
            msgDiv.innerHTML = contentHtml + deleteBtn;
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // åˆ é™¤å•æ¡æ¶ˆæ¯
        window.deleteMessage = async (id, btnElement) => {
            if(confirm('åˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ')) {
                // ä»å½“å‰ç‰ˆæœ¬çš„æ•°æ®åº“åˆ é™¤è®°å½•
                const currentDB = versionManager.getCurrentDB();
                await currentDB.deleteRecord(id);
                // ç§»é™¤ DOM
                const msgDiv = btnElement.closest('.message');
                msgDiv.remove();
            }
        };

        // è¾…åŠ©ï¼šæ·»åŠ æ–°æ¶ˆæ¯å¹¶ä¿å­˜
        async function addMessage(text, type, saveToDB = true) {
            // 1. æ„é€ æ•°æ®å¯¹è±¡
            const record = {
                role: type,
                content: text,
                // å¦‚æœæœ‰éŸ³é¢‘æ•°æ®ä¹Ÿå¯ä»¥å­˜: audioBase64: ...
            };

            // 2. ä¿å­˜åˆ°æ•°æ®åº“ (è·å– ID)
            let id;
            if (saveToDB && (type === 'user' || type === 'ai')) {
                try {
                    // ä¿å­˜åˆ°å½“å‰ç‰ˆæœ¬çš„æ•°æ®åº“
                    const currentDB = versionManager.getCurrentDB();
                    id = await currentDB.addRecord(record);
                } catch (e) {
                    console.error('Save failed:', e);
                }
            }

            // 3. æ¸²æŸ“
            renderMessage({ ...record, id });
        }

        // åˆå§‹åŒ–æ’ä»¶
        const voiceChat = new VoiceChat({
            // æ ¸å¿ƒï¼šé…ç½®ä½ çš„ API è°ƒç”¨é€»è¾‘
            apiHandler: async (base64Audio) => {
                // 0. è·å–å½“å‰æ¨¡å¼
                const currentVersion = await globalDB.getCurrentVersion();
                const mode = currentVersion || 'low';
                
                // åˆ‡æ¢ç‰ˆæœ¬ç®¡ç†å™¨åˆ°å½“å‰æ¨¡å¼
                versionManager.switchVersion(mode);
                
                // 1. è¯»å–è¯¥æ¨¡å¼çš„ä¸“å±é…ç½®
                const config = await versionManager.getVersionConfig(mode) || {};
                const systemPrompt = config.systemPrompt || 'ä½ æ˜¯ä¸€ä¸ªå¹½é»˜é£è¶£çš„AIåŠ©æ‰‹ã€‚';
                
                // 2. è·å–æœ¬åœ°è®°å¿† (æœ€è¿‘ 10 æ¡)
                const history = await versionManager.getCurrentDB().getHistory(10);
                
                // 3. æ„é€ é€šç”¨å‚æ•° (Params)
                const params = {
                    audio: base64Audio,
                    config: config, // ä¼ å…¥çš„æ˜¯å½“å‰æ¨¡å¼çš„ä¸“å±é…ç½®
                    history: history.map(msg => ({
                        role: msg.role === 'ai' ? 'assistant' : 'user',
                        content: msg.content
                    }))
                };

                console.log(`[${mode.toUpperCase()}] æ¨¡å¼å¯åŠ¨ - Config:`, config);

                // 4. ç­–ç•¥åˆ†å‘ (Strategy Dispatch)
                // æ ¹æ®é…ç½®çš„æ¨¡å¼ï¼Œè°ƒç”¨ç‰ˆæœ¬ç®¡ç†å™¨ä¸­å¯¹åº”çš„å‡½æ•°
                try {
                    const handler = versionManager.getStrategy(mode) || versionManager.getStrategy('low');
                    const result = await handler(params);
                    return result;
                } catch (e) {
                    console.error('API Error:', e);
                    return "å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é…ç½®";
                }
            },
            
            // çŠ¶æ€å›è°ƒ
            onStateChange: (state) => {
                console.log('å½“å‰çŠ¶æ€:', state);
                switch(state) {
                    case 'idle':
                        micBtn.classList.remove('recording', 'processing', 'playing');
                        btnText.innerText = 'æŒ‰ä½ è¯´è¯';
                        break;
                    case 'recording':
                        micBtn.classList.add('recording');
                        btnText.innerText = 'æ­£åœ¨è†å¬...';
                        break;
                    case 'processing':
                        micBtn.classList.remove('recording');
                        micBtn.classList.add('processing');
                        btnText.innerText = 'æ€è€ƒä¸­...';
                        break;
                    case 'playing':
                        micBtn.classList.remove('processing');
                        micBtn.classList.add('playing');
                        btnText.innerText = 'æ­£åœ¨å›å¤...';
                        break;
                }
            },

            // æ—¥å¿—å›è°ƒ
            onLog: (msg) => {
                console.log('[VoiceChat]', msg);
            },

            // é”™è¯¯å›è°ƒ
            onError: (err) => {
                console.error(err);
                addMessage(`å‡ºé”™äº†: ${err.message}`, 'system');
                alert('å‘ç”Ÿé”™è¯¯ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æˆ–é‡è¯•');
            }
        });

        // äº¤äº’é€»è¾‘ï¼šæŒ‰ä½è¯´è¯ (å…¼å®¹ PC å’Œ ç§»åŠ¨ç«¯)
        
        // ç§»åŠ¨ç«¯ Touch äº‹ä»¶
        micBtn.addEventListener('touchstart', (e) => {
            e.preventDefault(); // é˜²æ­¢æ»šåŠ¨
            voiceChat.startRecording();
        });

        micBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            voiceChat.stopRecording();
        });

        // PCç«¯ Mouse äº‹ä»¶
        micBtn.addEventListener('mousedown', () => {
            voiceChat.startRecording();
        });

        micBtn.addEventListener('mouseup', () => {
            voiceChat.stopRecording();
        });

        // æ‹¦æˆª APIHandler çš„è¿”å›ç»“æœæ¥æ˜¾ç¤ºåœ¨ UI ä¸Š
        // ç”±äº VoiceChat å†…éƒ¨ç›´æ¥è°ƒç”¨äº† apiHandler å¹¶å¤„ç†äº† TTSï¼Œ
        // æˆ‘ä»¬éœ€è¦ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ apiHandler æˆ–è€…åˆ©ç”¨ VoiceChat çš„è®¾è®¡ã€‚
        // è¿™é‡Œçš„ apiHandler æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œåš UI æ›´æ–°ã€‚
        const originalApiHandler = voiceChat.config.apiHandler;
        voiceChat.config.apiHandler = async (base64) => {
            addMessage("ï¼ˆå‘é€äº†ä¸€æ®µè¯­éŸ³ï¼‰", 'user');
            const text = await originalApiHandler(base64);
            addMessage(text, 'ai');
            return text;
        };

    </script>
</body>
</html>